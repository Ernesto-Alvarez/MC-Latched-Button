Latched button implementer's manual

1. System description

1.1. Textual description

This is version 2 of the project https://github.com/Ernesto-Alvarez/MC-Latched-Button.

The device uses a microcontroller to control a relay that can be connected to the power supply of mains powered devices. The button has to be pressed for a preconfigured amount of time (default 5 seconds) and keeps the relay closed for another configurable time (default 12 minutes). Device can be shutdown by pressing the button for a configurable amount of time (default: short press, 0.2 seconds).

The microcontroller (a pic 12F629) runs realtime code in a loop to allow a possible future upgrade that would allow serial communications on pins GP0 and GP1. The code would have to bit bang the protocol, so strict timing is necessary. Pin GP2 is connected to a button and pull-up. Pin GP4 is connected to a LED, used to acknowledge button pushes and GP5 is connected both to a relay (used for operating the controlled device) and a LED. This LED will turn on if and only if the relay is energized.

1.2. State diagrams

The device's state can be represented by two state machines. One machine defines the acknowledgement LED state while the other defines the relay's state.

1.2.1. LED State machine

1.2.1.1 Graph form 

          							        /----------------------Button press event-----------\
									v	    				            |

+---------+                 				 +-------------------+						+-------------+
| LED off | ----------Button press event---------------> | Button Pressed    | ----------Button release event--------> 	| Persistence |
|(state 0)|						 | (state 2)	     |					        |  (state 1)  |
+---------+                                              +-------------------+                                          +-------------+
      ^										                      	      			    |
       \----------------------------------------------------LED Timer expiration----------------------------------------------------/


1.2.1.2 State descriptions

There are 3 states: LED off, Button pressed and Presistence. The state numbers are created based on the states of different components of the device. See the tabular form for details on the representations. The numbers may be changed with a new implementation.

LED off represents the quiescent state of the device: the button has not been pressed and the timer is not running. The LED is off, waiting for a button press. A button press triggers the event that sets the state to 2 (button pressed).

Button pressed represents the state where the button has been pressed and has not yet been released (or is being released in this iteration). The button is on, the timer is not running and the LED is on. In each iteration in this state, the button is sensed. Detecting a button release in this state triggers the button release event, which changes state to 1 (persistence) and sets the persistence timer to the appropriate value, as defined in the program configuration EEPROM. Keeping the button pressed has the effect of remaining in this state.

In the Presistence state the timer counts down to 0, once per iteration of the real time loop, the LED is on, but the button is not pressed. There are two possible transitions from this state: the timer can expire or the button can be pressed again. If the timer expires, the device transitions to state 0 (LED off), the LED is turned off and the device goes to its quiescent state. If the button is pressed while in this state, the device returns to state 2 (Button pressed), which will eventually lead back to this state, counting anew.

1.2.1.3 Tabular representation

			LSB			MSB				LED state	State number
LED Off			Timer = 0 (off)		Button = 0 (not pressed)	Off		0
Persistence		Timer = 1 (running)	Button = 0 (not pressed)	On		1
Button pressed		Timer = 0 (off)		Button = 1 (pressed)		On		2

The LED state is not represented as bits in the state as its value is derived from the timer and button, using the formula below.

LED = Button OR Timer


1.2.2. Relay state machine

1.2.2.1 Graph form

 
                 +--------+                     +-----------+                   +--------------+
                 | Off    | ----Button press--> | Starting  | --Hold tmr exp--> | Started      |
                 |        | <---Button release- |           |                   |              |
                 +--------+                     +-----------+                   +--------------+
                    ^ ^ ^                                                         |        |
                    | | |                                                         |        |
                    | | |                                                         |        | Relay
                    | | |                       +-----------+                     |        | timer
                    | | +--Relay timer exp------| On        |<-Button release-----+        | expires
                    | |                         |           |                              |
                    | |                         +-----------+                              |
                    | |                            |     ^                                 |
                    | |                    Button  |     |  Button                         |
                    | |                    press   |     |  release                        |
                    | |                            |     |                                 |
                    | |                            v     |                                 v
                    | |                         +-----------+                   +--------------+
                    | |                         | Aborting  | --Abort tmr exp-> | Aborted      |
                    | |                         |           |                   |              |
                    | |                         +-----------+                   +--------------+
                    | |                            | Relay timer                  ^        |
                    | |                            v expires                      |        | Button
                    | |                         +-----------+                     |        | Release
                    | +---Button release ------ | FWA       | --Abort tmp exp-----+        |
                    |                           |           |                              |
                    |                           +-----------+                              |
                    |                                                                      |
                    +----------------------------------------------------------------------+


1.2.2.2 State descriptions

There are 7 valid states: Off, Starting, Started, On, Aborting, Aborted and FWA (finished while aborting). These states are based on three timers (hold, abort and relay), the button status and the relay status.

The Off state represents the device waiting to be activated. Timers are not running, the button is not pressed and the relay is open. Only a button press can cause a transition to the Starting state.

The Starting state is entered on a button press. The button is pressed and the hold timer is running. The device is waiting for enough time to elapse while the button is being held, to rule out a false activation. In this state, the device reacts to two events. If the button is released, the device returns to the Off state. If the hold timer expires the device goes to the Started state, energizing the relay in the process.

The Started state represents the initial time when the user has successfully activated the device, but has not yet released the button. The relay timer is on, while the hold timer is stopped. The usual transition would happen when the user releases the button, and the device transitions to the On state. Should the relay timer expire before the button is released (short timer, user keeping the button pressed for a full cicle, or stuck button), the device goes to the aborted state.

The On state represents the usual mode of operation when the device is active. The button is not pressed, the relay timer is the only one running and the relay is on. There are two possible transitions from this state. If the relay timer expires, the device goes to the Off state and shuts down. If the user presses the button, the device goes to the aborting state, in preparation for a premature shutdown.

The Aborting state is the analog of the Starting state, but for shutdowns. The button is pressed, the abort timer is counting but the relay (and its timer) is running as well. Unlike its analog, there are 3 possible transitions. If the button is released, the device goes to the On state and the shutdown is canceled. If the abort timer expires, the device goes to the Aborted state. Unlike the Starting state, this state has a third possibility: the relay timer could expire while the abort timer is running (which could happen if aborting when the relay timer is about to expire). In that case, the device goes to the FWA state.

The Aborted state is analogous to the Started state, but simpler. In thois state, the device waits for the button release to transition to the Off state. No timers are running, the relay is off and there is no other possible transition than waiting for a button release and shutting off.

The FWA (finished while aborting) state is a special case, which happens if the button is pressed close to the end of the activation cycle (e.g. when aborting a cycle that is about to end). In this case, the relay timer is turned off but the abort timer is kept on. Should the button be released, the device will immediately go to the Off state. If the button is kept pressed long enough to allow the abort timer to expire, the device will go to the aborted state. In both cases, the device recovers from what could be a race condition.

1.2.2.3 Tabular representation

The table below shows the state of each of the timers and the button. Each value is represented in one bit of the implementation variable. 

		(LSB)						(MSB)
		RelayTmr	HoldTmr		AbortTmr	Button		State number
Off		Off		Off		Off		OFf		0
On		On		Off		Off		Off		1
Aborted		Off		Off		Off		On		8
Started		On		Off		Off		On		9
Starting	Off		On		Off		On		10
FWA		Off		Off		On		On		12
Aborting	On		Off		On		On		13

The relay is energized if and only if the Relay Timer is running (on).

2. Hardware

3. Software